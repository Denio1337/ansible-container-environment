# Готовое контейнерное окружение для изучения Ansible

## Общее описание

Предоставляет возможность поднять контейнерное окружение из 3 узлов:

- Управляющий узел с именем control, ОС Ubuntu и установленным Ansible
- Два управляемых узла с именами managed1 и managed2, ОС Ubuntu

## Настройка окружения

Перед запуском контейнеров необходимо создать файл `.env` в корне склонированного репозитория и заполнить его по аналогии с файлом `.env.example`. В нём приведены поясняющие комментарии к каждому параметру.

В файле необходимо указать следующие переменные:

- `SSH_PASSWORD` - пароль для пользователя root на управляемых узлах, используется при первом подключении по SSH с управляющего узла для регистрации ключа и последующего беспарольного подключения.

## Запуск и использование

Для поднятия контейнеров используется единственная команда:

```sh
docker compose up
```

После подъёма контейнеров можно подключиться к управляющему узлу с помощью:

```sh
docker exec -it control bash
```

И выполнять различные команды Ansible для управления двумя узлами, например:

```sh
ansible managed -i inventory.ini -m ping
```

Команда выше задействует модуль Ansible `ping` для выполнения соответствующей команды для всех узлов из группы `managed` инвентаря из файла `inventory.ini`.

Файлы конфигурации для использования Ansible настраиваются в каталоге с соответствующим названием.

## Подробное описание

### Dockerfile.managed

- Dockerfile для сборки образа управляемого узла.
- Основан на ОС Ubuntu последней версии.
- Настраивается SSH для прослушивания подключений с управляемого узла.
- Пароль задаётся аргументом `PASSWORD` при сборке.

### Dockerfile.control

- Dockerfile для сборки образа управляющего узла.
- Основан на ОС Ubuntu последней версии.
- Устанавливается Ansible.

### docker-compose.yml

- Общий compose-файл для подъёма всего контейнерного окружения.
- Запуск управляющего узла сопровождается исполнением скрипта `ansible/entrypoint.sh`.
- Пробрасывает переменные окружения из файла `.env` в окружение управляющего контейнера, чтобы он мог первый раз подключиться по SSH с целью регистрации ключа.
- Пробрасывает переменные окружения из файла `.env` в аргументы при сборке образа управляемых узлов, чтобы при сборке установился необходимый пароль от root для последующего подключения по SSH с управляющего контейнера.

### ansible/entrypoint.sh

- Генерация и копирование ключа SSH на управляемые узлы для последующего беспарольного подключения.
