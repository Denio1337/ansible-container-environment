# Готовое контейнерное окружение для изучения Ansible

## Общее описание

Предоставляет возможность поднять контейнерное окружение из 3 узлов:

- Управляющий узел с именем control, ОС Ubuntu и установленным Ansible.
- Два управляемых узла с именами managed1 и managed2, ОС Ubuntu.

## Настройка окружения

Перед запуском контейнеров необходимо настроить переменные окружения. Для этого нужно создать файл `.env` в корне склонированного репозитория и заполнить его по аналогии с файлом `.env.example`. Каждая переменная в нём дополнена коротким поясняющим комментарием.

- `SSH_PASSWORD` - пароль для пользователя root на управляемых узлах, используется при первом подключении по SSH с управляющего узла для регистрации ключа и последующего беспарольного подключения.

## Запуск и использование

Для поднятия контейнеров используется единственная команда:

```sh
docker compose up
```

После подъёма контейнеров можно подключиться к терминалу управляющего узла с помощью:

```sh
docker exec -it control bash
```

Из него можно выполнять различные команды Ansible для управления двумя узлами, например:

```sh
ansible managed -m ping
```

Команда выше задействуют модуль Ansible `ping` для выполнения соответствующей команды для всех узлов из группы `managed` дефолтного инвентаря.

Пример плейбука располагается по пути `ansible/playbooks/playbook` и может быть запущен следующим образом:

```sh
ansible-playbook playbooks/playbook
```

Данный пример плейбука задействует модуль `ping` для проверки соединения с двумя управляемыми узлами группы `managed` дефолтного инвентаря.

## Файлы конфигурации

`ВАЖНО`: Директория `ansible` монтируется в управляющий контейнер. Это позволяет редактировать файлы конфигурации вне контейнеров налету без необходимости пересборки образов и перезапуска контейнеров. Однако это даёт возможность редактировать (и в том числе удалять) файлы изнутри контейнера, что повлияет на саму директорию в файловой системе, на которой запускается это окружение. Так что с этим стоит быть осторожным.

Файлы конфигурации для использования Ansible настраиваются в каталоге `ansible`. Содержимое основного конфигурационного файла `cfg` копируется по дефолтному пути Ansible `/etc/ansible/ansible.cfg` при запуске контейнеров.

В следующих каталогах, вложенных по отношению к каталогу `ansible`, находятся файлы конфигурации, используемые Ansible по умолчанию:

- `inventories` - инвентарь, описание управляемых хостов и их параметров, распределение по группам.

## Подробное описание

### Dockerfile.managed

- Dockerfile для сборки образа управляемого узла.
- Основан на ОС Ubuntu последней версии.
- Настраивается SSH для прослушивания подключений с управляемого узла.
- Пароль задаётся аргументом `PASSWORD` при сборке.

### Dockerfile.control

- Dockerfile для сборки образа управляющего узла.
- Основан на ОС Ubuntu последней версии.
- Устанавливается Ansible.

### docker-compose.yml

- Общий compose-файл для подъёма всего контейнерного окружения.
- Запуск управляющего узла сопровождается исполнением скрипта `ansible/entrypoint.sh`.
- Пробрасывает переменные окружения из файла `.env` в окружение управляющего контейнера, чтобы он мог первый раз подключиться по SSH с целью регистрации ключа.
- Пробрасывает переменные окружения из файла `.env` в аргументы при сборке образа управляемых узлов, чтобы при сборке установился необходимый пароль от root для последующего подключения по SSH с управляющего контейнера.

### ansible/entrypoint.sh

- Генерация и копирование ключа SSH на управляемые узлы для последующего беспарольного подключения.
