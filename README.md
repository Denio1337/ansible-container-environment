# Готовое контейнерное окружение для изучения Ansible

## Общее описание

Предоставляет возможность поднять контейнерное окружение из 3 узлов:

- Управляющий узел с именем control, ОС Ubuntu и установленным Ansible.
- Два управляемых узла с именами managed1 и managed2, ОС Ubuntu.

## Настройка окружения

Перед запуском контейнеров необходимо настроить переменные окружения. Для этого нужно создать файл `.env` в корне склонированного репозитория и заполнить его по аналогии с файлом `.env.example`. Каждая переменная в нём дополнена коротким поясняющим комментарием.

- `SSH_PASSWORD` - пароль для пользователя root на управляемых узлах, используется при первом подключении по SSH с управляющего узла для регистрации ключа и последующего беспарольного подключения.

## Запуск и использование

Для поднятия контейнеров используется единственная команда:

```sh
docker compose up
```

После подъёма контейнеров можно подключиться к терминалу управляющего узла с помощью:

```sh
docker exec -it control bash
```

Из него можно выполнять различные команды Ansible для управления двумя узлами, например:

```sh
ansible managed -m ping
```

Команда выше задействует модуль Ansible `ping` для выполнения соответствующей команды для всех узлов из группы `managed` дефолтного инвентаря.

## Конфигурация

`ВАЖНО`: Директория `ansible` монтируется в управляющий контейнер. Это позволяет редактировать файлы конфигурации вне контейнеров налету без необходимости пересборки образов и перезапуска контейнеров. Однако это даёт возможность редактировать (и в том числе удалять) файлы изнутри контейнера, что повлияет на директорию репозиторя. Так что с этим стоит быть осторожным.

Файлы конфигурации для использования Ansible настраиваются в каталоге `ansible`. Содержимое основного конфигурационного файла `cfg` копируется по дефолтному пути Ansible `/etc/ansible/ansible.cfg` при запуске контейнеров.

### Инвентари

Файлы инвентарей находятся в каталоге `ansible/inventories` и используются Ansible в качестве файлов инвентарей по умолчанию (задано в файле `cfg`). Это означает, что при выполнении команды `ansible` нет необходимости явно указывать путь к файлу инвентаря с помощью параметра командной строки `-i`.

Можно как редактировать единственный стандартный файл инвентаря по пути `ansible/inventories/inventory`, так и добавлять новые файлы, которые будут автоматически подхватываться и использоваться Ansible в управляющем контейнере.

### Плейбуки

В каталоге `ansible/playbooks` располагаются файлы с плейбуками-примерами, которые можно использовать в качестве отправной точки для написания собственных:

- `ping` - задействует одноимённый модуль для проверки связи с управляемыми узлами группы `managed` дефолтного инвентаря.
- `mysql` - более сложный пример, показывающий процесс установки и конфигурации MariaDB.
- `mysql-role` - аналогичен `mysql`, но использует вынесенную в отдельный каталог роль.

Плейбуки можно запускать командой:

```sh
ansible-playbook playbooks/ping
```

По любому пути в каталоге `ansible` можно создавать и редактировать собственные плейбуки и затем запускать их с помощью вышеуказанной команды.

### Роли

Роли располагаются в каталоге `ansible/roles` и используются Ansible в качестве ролей по умолчанию (задано в файле `cfg`).

В каталоге имеется пример роли `mysql-role`, который производит установку и первоначальную настройку MariaDB на управляемых узлах.

С помощью утилиты командной строки `ansible-galaxy` из управляющего контейнера можно создавать и наполнять скелеты для новых ролей в соответствующем каталоге. Они будут автоматически подхватываться и использоваться Ansible при выполнении плейбуков, использующих роли. Пример использования:

```sh
# Инициализация скелета роли
ansible-galaxy init mysql-role

# Запуск примера плейбука mysql-role, использующего одноимённую роль
ansible-playbook playbooks/mysql-role
```

### Узлы

Конфигурацию узлов можно изменить, редактируя файл `docker-compose.yml` в корне репозитория. Например, можно добавить ещё один управляемый узел-контейнер, добавив соответствующую секцию в этот файл:

```yml
# docker-compose.yml
# ...
managed3:
  build:
    context: .
    dockerfile: Dockerfile.managed
    args:
      PASSWORD: ${SSH_PASSWORD}
  container_name: managed3
  networks:
    - ansible-net
# ...
```

Для запуска управляемых узлов необязательно использовать единый образ. Например, если есть желание протестировать работу Ansible с узлами разных ОС, можно создать новые Dockerfile, где указать в качестве базового желаемый образ:

```Dockerfile
# Dockerfile.managed.alpine
# Облегчённый Linux
FROM alpine:latest
# ...
```

`Примечание:` Файл ивентаря при добавлении новых или удалении существующих узлов нужно актуализировать, чтобы Ansible мог получить информацию о текущей конфигурации. Для вышеприведённых изменений дефолтный файл инвентаря по пути `ansible/inventories/inventory` должен быть дополнен следующей строкой:

```ini
# ansible/inventories/inventory
# ...
managed3 ansible_host=managed3 ansible_port=22 ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_python_interpreter=/usr/bin/python3
```

## Подробное описание

### Dockerfile.managed

- Dockerfile для сборки образа управляемого узла.
- Основан на ОС Ubuntu последней версии.
- Настраивается SSH для прослушивания подключений с управляющего узла.
- Пароль задаётся аргументом `PASSWORD` при сборке.

### Dockerfile.control

- Dockerfile для сборки образа управляющего узла.
- Основан на ОС Ubuntu последней версии.
- Устанавливается Ansible.

### docker-compose.yml

- Общий compose-файл для подъёма всего контейнерного окружения.
- Запуск управляющего узла сопровождается исполнением скрипта `ansible/entrypoint.sh`.
- Пробрасывает переменные окружения из файла `.env` в окружение управляющего контейнера, чтобы он мог первый раз подключиться по SSH с целью регистрации ключа.
- Пробрасывает переменные окружения из файла `.env` в аргументы при сборке образа управляемых узлов, чтобы при сборке установился необходимый пароль от root для последующего подключения по SSH с управляющего контейнера.

### ansible/entrypoint.sh

- Генерация и копирование ключа SSH на управляемые узлы для последующего беспарольного подключения.
- Копирование конфигурации Ansible по дефолтному пути.
